# 金丝雀发布

> 来源: CI/CD
> 创建时间: 2024-06-23T12:30:04+08:00
> 更新时间: 2026-01-17T19:21:19.914672+08:00
> 阅读量: 911 | 点赞: 0

---

# 概念介绍
金丝雀发布（Canary Release）是一种软件发布策略，旨在逐步推出新版本的应用程序，以便在实际生产环境中小规模测试新版本的功能和性能，减少发布风险。这个名字来源于矿工在矿井中使用金丝雀作为早期预警系统的做法，金丝雀发布也是为了在早期阶段发现潜在问题。

## 基本概念
1. 逐步发布：新版本的应用程序不会立即替换旧版本，而是逐步地、小规模地发布给一小部分用户。
2. 实时监控：在金丝雀发布过程中，实时监控新版本的性能和行为，以便及时发现和处理问题。
3. 快速回滚：如果新版本出现问题，可以迅速回滚到旧版本，确保服务稳定。
4. 分流流量：将一部分用户流量导向新版本，剩余流量继续使用旧版本。随着新版本被验证稳定，可以逐步增加导向新版本的流量比例，直到完全替换旧版本。

## 发布流程
1. 准备环境：
    - 确保当前的生产环境运行稳定，并且具有良好的监控和日志记录机制。
    - 配置必要的工具和平台（以支持金丝雀发布策略。
2. 部署金丝雀版本：
    - 将新版本部署到生产环境中，但仅运行少量实例（如一个或少数几个 Pod）。
    - 这些实例通常会有专门的标记（label）或服务（service）用于识别和流量路由。
3. 流量分配：
    - 通过负载均衡器，将一小部分用户流量导向新版本。
    - 大部分用户流量仍然导向旧版本，以保证整体服务的稳定性。
4. 监控和验证：
    - 实时监控新版本的关键性能指标（如响应时间、错误率、资源使用等）。
    - 收集用户反馈和日志信息，检查是否存在错误或性能问题。
5. 逐步扩展：
    - 如果新版本表现良好，逐步增加导向新版本的流量比例。
    - 每次增加流量后，重复监控和验证步骤，确保新版本继续表现稳定。
6. 全面发布或回滚：
    - 如果新版本在所有流量下均表现稳定，最终完全替换旧版本。
    - 如果发现问题，立即回滚到旧版本，停止导向新版本的流量。

![](images/1768648879945_1719238097595-53e8e336-d2a5-4155-8cad-5d3bb6024484.png)

# 创建Rollout及资源
## rollout.yaml
创建rollout资源，定义发布策略和对应的server，以及deployment信息。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: canary-rollout
spec:
  replicas: 10 # 定义期望的 Pod 副本数
  strategy: # 定义升级策略
    canary: # 金丝雀发布
      # 2个 svc 名称
      canaryService: canary-active  # 正式版本服务名
      stableService: canary-preview  # 预览版本服务名
      trafficRouting: # 配置加权轮循规则
        # nginx ingress 配置：官方文档：https://argoproj.github.io/argo-rollouts/features/traffic-management/nginx/
        # nginx:
        #   # Either stableIngress or stableIngresses must be configured, but not both.
        #   stableIngress: demo-stable-ingress
        # traefik 配置: 官方文档：https://argoproj.github.io/argo-rollouts/features/traffic-management/traefik/
        traefik: 
          weightedTraefikServiceName: canary-service # traefik加权轮循服务名
      steps:  # 发布的节奏
      - setWeight: 10 # 将10%的流量导向新版本
      - pause:
          duration: 5m # 暂停5分钟，用于监控新版本的表现。
      - setWeight: 30 # 将30%的流量导向新版本
      - pause:
          duration: 1m # 暂停1分钟，用于监控新版本的表现。
      - setWeight: 60 # 将60%的流量导向新版本
      - pause:
          duration: 30s # 暂停30秒钟，用于监控新版本的表现。
      - setWeight: 100 # 将 100% 的流量导向新版本，完成金丝雀发布。
  revisionHistoryLimit: 2 # 保留的修订历史版本数
  selector: # 定义Pod模板标签，类似deployment
    matchLabels:
      app: myapp
  template: # 定义Pod模板，类似deployment
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: ikubernetes/myapp:v1
        ports:
        - name: http
          containerPort: 80
          protocol: TCP
```

## service.yaml
```yaml
# 接收生产流量的Service
apiVersion: v1
kind: Service
metadata:
  name: canary-active
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - name: http
    port: 80
---
# 接收预览测试流量的Service
apiVersion: v1
kind: Service
metadata:
  name: canary-preview
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - name: http
    port: 80
```

## ingress.yaml
由于argocd老版本并未适配traefik3.1。因此推荐升级argocd版本或者降低traefik版本至2.X，或者3.X的traefik创建TraefikService时两个接口都创建。

```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: TraefikService # traefik加权轮循服务
metadata:
  name: canary-service
spec:
  weighted:
    services:
      - name: canary-active # 正式版本服务名
        port: 80
      - name: canary-preview # 预览版本服务名
        port: 80
---
apiVersion: traefik.io/v1alpha1
kind: TraefikService # traefik加权轮循服务
metadata:
  name: canary-service
spec:
  weighted:
    services:
      - name: canary-active # 正式版本服务名
        port: 80
      - name: canary-preview # 预览版本服务名
        port: 80
---
# 生产环境service对应的ingress
apiVersion: traefik.io/v1alpha1
kind: IngressRoute # traefik路由转发服务
metadata:
  name: myapp-canary
spec:
  entryPoints:
  - web
  routes:
  - match: Host(`canary.myapp.com`) # 域名
    kind: Rule
    services:
      - name: canary-service # 关联traefik加权轮循服务
        kind: TraefikService
```

# 创建Argo App
## 推送文件至仓库
使用gitops理念，将yaml文件推送至git仓库，由argoCD负责完成部署。

```yaml
[root@tiaoban argo-demo]# git add . && git commit -m "add argorollout-canary" && git push
```

此时git仓库内容如下

![](images/1768648880083_1719241266346-622b71a6-1c3d-4b9b-9914-0b6c0e445d6c.png)

## 创建Directory App
```yaml
[root@tiaoban argocd]# cat canary.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: canary
  namespace: argocd
spec:
  destination:
    name: ''
    namespace: default
    server: 'https://kubernetes.default.svc'
  source:
    path: argorollout-canary
    repoURL: 'http://gitlab.local.com/devops/argo-demo.git'
    targetRevision: main
  sources: []
  project: default
  syncPolicy:
    automated:
      prune: false
      selfHeal: false
[root@tiaoban argocd]# kubectl apply -f canary.yaml 
application.argoproj.io/canary created
```

## 查看验证
查看argo dashboard，已经显示canary应用成功部署。

![](images/1768648880156_1719241314438-e65fa783-ead0-40ad-aea4-272d6ccae1ea.png)

CLI查看应用状态

```bash
[root@tiaoban argocd]# argocd login argocd.local.com
[root@tiaoban argocd]# argocd app list
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web. 
NAME           CLUSTER                         NAMESPACE  PROJECT       STATUS  HEALTH   SYNCPOLICY  CONDITIONS  REPO                                          PATH                TARGET
argocd/canary  https://kubernetes.default.svc  default    default       Synced  Healthy  Auto        <none>      http://gitlab.local.com/devops/argo-demo.git  argorollout-canary  main
argocd/demo    https://kubernetes.default.svc             demo-project  Synced  Healthy  Auto        <none>      http://gitlab.local.com/devops/argo-demo.git  manifests           HEAD
[root@tiaoban argocd]# kubectl get application -n argocd
NAME     SYNC STATUS   HEALTH STATUS
canary   Synced        Healthy
demo     Synced        Healthy
```

kubectl查看状态

```bash
[root@tiaoban argocd]# kubectl get pod
NAME                              READY   STATUS    RESTARTS       AGE
canary-rollout-69dc9f5f56-28rcd   1/1     Running   0              11s
canary-rollout-69dc9f5f56-4l4wk   1/1     Running   0              11s
canary-rollout-69dc9f5f56-9wfl4   1/1     Running   0              11s
canary-rollout-69dc9f5f56-dntp5   1/1     Running   0              11s
canary-rollout-69dc9f5f56-fbhxx   1/1     Running   0              11s
canary-rollout-69dc9f5f56-jkj8j   1/1     Running   0              11s
canary-rollout-69dc9f5f56-mxrsb   1/1     Running   0              11s
canary-rollout-69dc9f5f56-ptgmc   1/1     Running   0              11s
canary-rollout-69dc9f5f56-qkzxd   1/1     Running   0              11s
canary-rollout-69dc9f5f56-rhl68   1/1     Running   0              11s
[root@tiaoban argocd]# kubectl get svc
NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
canary-active    ClusterIP   10.108.166.128   <none>        80/TCP     89s
canary-preview   ClusterIP   10.98.9.90       <none>        80/TCP     89s
[root@tiaoban argocd]# kubectl get ingressroute
NAME         AGE
myapp-canary 31s
```

添加hosts解析后访问ingress验证

![](images/1768648880227_1719241584062-b2bda143-b77f-485d-a5c7-82327056ca04.png)

# 更新版本
## 查看Rollouts状态
在更新应用版本前，先查看Rollouts状态，便于后续更新后对比效果。

```yaml
[root@tiaoban ~]# kubectl argo rollouts get rollout canary-rollout
Name:            canary-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        Canary
  Step:          7/7
  SetWeight:     100
  ActualWeight:  100
Images:          ikubernetes/myapp:v1 (stable)
Replicas:
  Desired:       10
  Current:       10
  Updated:       10
  Ready:         10
  Available:     10

NAME                                        KIND        STATUS     AGE  INFO
⟳ canary-rollout                            Rollout     ✔ Healthy  63s  
└──# revision:1                                                         
   └──⧉ canary-rollout-69dc9f5f56           ReplicaSet  ✔ Healthy  63s  stable
      ├──□ canary-rollout-69dc9f5f56-28rcd  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-4l4wk  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-9wfl4  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-dntp5  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-fbhxx  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-jkj8j  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-mxrsb  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-ptgmc  Pod         ✔ Running  63s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-qkzxd  Pod         ✔ Running  63s  ready:1/1
      └──□ canary-rollout-69dc9f5f56-rhl68  Pod         ✔ Running  63s  ready:1/1
```

此时可以看到，只有一个canary-rollout-69dc9f5f56控制器在提供服务。

## 更新应用版本
修改rollout.yaml，将image镜像从v1升级为v2。

```bash
[root@tiaoban argocd]# cat argorollout-canary/rollout.yaml | grep image
        image: ikubernetes/myapp:v2
[root@tiaoban argo-demo]# git add . && git commit -m "update v2" && git push
```

## 流量状态观察
待ArgoCD完成自动部署后，再次查看资源状态信息。此时可以发现增加了1个副本的v2版本的canary。

```bash
[root@tiaoban argocd]# kubectl argo rollouts get rollout bluegreen-rollout
Name:            canary-rollout
Namespace:       default
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          1/7
  SetWeight:     10
  ActualWeight:  10
Images:          ikubernetes/myapp:v1 (stable)
                 ikubernetes/myapp:v2 (canary)
Replicas:
  Desired:       10
  Current:       11
  Updated:       1
  Ready:         11
  Available:     11

NAME                                        KIND        STATUS     AGE    INFO
⟳ canary-rollout                            Rollout     ॥ Paused   2m23s  
├──# revision:2                                                           
│  └──⧉ canary-rollout-95d95c65             ReplicaSet  ✔ Healthy  3s     canary
│     └──□ canary-rollout-95d95c65-jj54b    Pod         ✔ Running  3s     ready:1/1
└──# revision:1                                                           
   └──⧉ canary-rollout-69dc9f5f56           ReplicaSet  ✔ Healthy  2m23s  stable
      ├──□ canary-rollout-69dc9f5f56-28rcd  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-4l4wk  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-9wfl4  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-dntp5  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-fbhxx  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-jkj8j  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-mxrsb  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-ptgmc  Pod         ✔ Running  2m23s  ready:1/1
      ├──□ canary-rollout-69dc9f5f56-qkzxd  Pod         ✔ Running  2m23s  ready:1/1
      └──□ canary-rollout-69dc9f5f56-rhl68  Pod         ✔ Running  2m23s  ready:1/1
```

此时查看pod信息，新增了canary-rollout-95d95c65-n6hsl的pod，运行v2版本的镜像。

```bash
[root@tiaoban ~]# kubectl get pod
NAME                              READY   STATUS    RESTARTS        AGE
canary-rollout-69dc9f5f56-28rcd   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-4l4wk   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-9wfl4   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-dntp5   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-fbhxx   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-jkj8j   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-mxrsb   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-ptgmc   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-qkzxd   1/1     Running   0               2m47s
canary-rollout-69dc9f5f56-rhl68   1/1     Running   0               2m47s
canary-rollout-95d95c65-jj54b     1/1     Running   0               27s
```

查看traefik dashboard，此时active权重为90，preview权重为10。

![](images/1768648880287_1719242825412-c294fd21-0007-4ad3-a549-c400541e75ff.png)

此时连续发起10次请求，查看响应信息

```bash
[root@tiaoban ~]# for i in {1..10}; do curl canary.myapp.com; done
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
```

可以看到，在前5分钟只有10%的流量请求到了v2版本的服务中。

10分钟后，金丝雀发布完成，此时再次访问验证，流量全部到v2版本的服务，且v1版本的服务已经停止。

```bash
[root@tiaoban ~]# for i in {1..10}; do curl canary.myapp.com; done
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
[root@tiaoban ~]# kubectl argo rollouts get rollout canary-rollout
Name:            canary-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        Canary
  Step:          7/7
  SetWeight:     100
  ActualWeight:  100
Images:          ikubernetes/myapp:v2 (stable)
Replicas:
  Desired:       10
  Current:       10
  Updated:       10
  Ready:         10
  Available:     10

NAME                                      KIND        STATUS        AGE    INFO
⟳ canary-rollout                          Rollout     ✔ Healthy     14m    
├──# revision:2                                                            
│  └──⧉ canary-rollout-95d95c65           ReplicaSet  ✔ Healthy     11m    stable
│     ├──□ canary-rollout-95d95c65-jj54b  Pod         ✔ Running     11m    ready:1/1
│     ├──□ canary-rollout-95d95c65-glmvn  Pod         ✔ Running     6m52s  ready:1/1
│     ├──□ canary-rollout-95d95c65-np99r  Pod         ✔ Running     6m52s  ready:1/1
│     ├──□ canary-rollout-95d95c65-pd4xr  Pod         ✔ Running     5m51s  ready:1/1
│     ├──□ canary-rollout-95d95c65-qb76x  Pod         ✔ Running     5m51s  ready:1/1
│     ├──□ canary-rollout-95d95c65-s7gdh  Pod         ✔ Running     5m51s  ready:1/1
│     ├──□ canary-rollout-95d95c65-9s4kl  Pod         ✔ Running     5m20s  ready:1/1
│     ├──□ canary-rollout-95d95c65-bvgqd  Pod         ✔ Running     5m20s  ready:1/1
│     ├──□ canary-rollout-95d95c65-l2tp4  Pod         ✔ Running     5m20s  ready:1/1
│     └──□ canary-rollout-95d95c65-q64rc  Pod         ✔ Running     5m20s  ready:1/1
└──# revision:1                                                            
   └──⧉ canary-rollout-69dc9f5f56         ReplicaSet  • ScaledDown  14m 
```

查看traefik负载均衡权重，此时active权重为0，preview权重为100。

![](images/1768648880362_1719242994101-abf1dfd3-7a10-46cf-83cf-a4b699f23a13.png)

# 版本回退与中止发布
与前文蓝绿部署操作过程一致，此处不再赘述。




