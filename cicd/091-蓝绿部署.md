# 蓝绿部署

> 来源: CI/CD
> 创建时间: 2024-06-23T12:30:06+08:00
> 更新时间: 2026-01-17T19:21:18.256974+08:00
> 阅读量: 989 | 点赞: 0

---

# 概念介绍
蓝绿部署（Blue-Green Deployment）是一种软件发布技术，旨在最大限度地减少应用程序的停机时间，并减少在部署新版本时对用户的影响。这个方法通过运行两个独立的环境（通常称为“蓝色环境”和“绿色环境”）来实现。

## 基本概念
1. 蓝色环境（Blue Environment）：这是当前正在生产环境中运行的版本，用户所有的请求都被路由到这个环境中。
2. 绿色环境（Green Environment）：这是一个与蓝色环境完全相同的环境，用于部署和测试新版本的应用程序。

## 发布流程
1. 初始部署： 蓝色环境是运行应用程序稳定版本的初始生产环境。用户通过该环境访问应用程序，并作为与更新版本进行比较的基线。

![](images/1768648878288_1719237579452-2e1382d9-0305-4d6f-ab96-7f2bc3c991c9.png)

2. 更新部署： 应用程序的更新版本部署到绿色环境，该环境在基础设施、配置和数据方面镜像蓝色环境。绿色环境最初与用户流量保持隔离。

![](images/1768648878387_1719237591691-9f976be3-bae8-4616-820c-2e180dd40aff.png)

3. 测试和验证： 绿色环境经过彻底测试，以确保更新版本功能正确并满足所需的质量标准。这包括运行自动化测试、执行集成测试以及可能进行用户验收测试或金丝雀发布。
4. 流量切换： 一旦绿色环境通过了所有必要的测试和验证，流量路由机制就会调整为开始将用户流量从蓝色环境引导到绿色环境。此切换可以使用各种技术来完成，例如 DNS 更改、负载平衡器配置更新或反向代理设置。

![](images/1768648878486_1719237655908-29b41556-f1ef-4730-8650-b975b33a294f.png)

5. 监控和验证： 在整个部署过程中，蓝色和绿色环境都会受到监控，以检测任何问题或异常情况。监控工具和可观察性实践有助于实时识别性能问题、错误或不一致。验证无误后可删除老版本资源。

![](images/1768648878620_1719237795518-be7b1728-c2c2-4ab4-ae9f-41dff5ded989.png)

6. 回滚和清理： 当出现意外问题或结果不理想时，可以采用回滚策略将流量切换回蓝色环境，恢复到稳定版本。此外，在部署过程中在绿色环境中进行的任何资源或更改可能需要清理或恢复。

# 创建Rollout及资源
## rollout.yaml
创建rollout资源，定义发布策略和对应的server，以及deployment信息。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: bluegreen-rollout # 定义Rollout的名称
spec:
  replicas: 2 # 期望副本数
  strategy:
    blueGreen: # 指定蓝绿部署策略
      activeService: bluegreen-active # 用于接收生产流量的Service
      previewService: bluegreen-preview # 用于接收预览流量的Service
      autoPromotionEnabled: false # 是否自动提升预览版本为活动版本
      previewReplicaCount: 1 # 预览版本的副本数
  revisionHistoryLimit: 2 # 保留的历史版本
  selector: # 类似deployment的selector
    matchLabels:
      app: myapp
  template: # 类似deployment的template
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: ikubernetes/myapp:v1
        ports:
        - name: http
          containerPort: 80
          protocol: TCP
```

## service.yaml
```yaml
# 接收生产流量的Service
apiVersion: v1
kind: Service
metadata:
  name: bluegreen-active
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - name: http
    port: 80
---
# 接收预览流量的Service
apiVersion: v1
kind: Service
metadata:
  name: bluegreen-preview
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - name: http
    port: 80
```

## ingress.yaml
```yaml
# 生产环境service对应的ingress
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: myapp-prod
spec:
  entryPoints:
  - web
  routes:
  - match: Host(`prod.myapp.com`) # 生产环境域名
    kind: Rule
    services:
      - name: bluegreen-active  # 与svc的name一致
        port: 80 # 与svc的port一致
---
# 预览环境service对应的ingress
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: myapp-test
spec:
  entryPoints:
  - web
  routes:
  - match: Host(`test.myapp.com`) # 测试环境域名
    kind: Rule
    services:
      - name: bluegreen-preview # 与svc的name一致
        port: 80 # 与svc的port一致
```

# 创建Argo App
## 推送文件至仓库
使用gitops理念，将yaml文件推送至git仓库，由argoCD负责完成部署。

```yaml
[root@tiaoban argo-demo]# git add . && git commit -m "add argorollout-blue-green" && git push
[main ec83440] add argorollout-blue-green
 5 files changed, 57 insertions(+), 27 deletions(-)
 create mode 100644 argorollout-blue-green/ingress.yaml
 delete mode 100644 argorollout-blue-green/service-active.yaml
 delete mode 100644 argorollout-blue-green/service-preview.yaml
 create mode 100644 argorollout-blue-green/service.yaml
枚举对象中: 9, 完成.
对象计数中: 100% (9/9), 完成.
使用 4 个线程进行压缩
压缩对象中: 100% (6/6), 完成.
写入对象中: 100% (6/6), 922 字节 | 922.00 KiB/s, 完成.
总共 6（差异 2），复用 0（差异 0），包复用 0
To http://gitlab.cuiliangblog.cn/devops/argo-demo.git
   3929004..ec83440  main -> main
```

此时git仓库内容如下

![](images/1768648878741_1719202991228-a10d33af-1530-4a48-95e3-e62052f05519.png)

## 创建Directory App
```yaml
[root@tiaoban argocd]# cat blue-green.yaml 
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: blue-green
  namespace: argocd
spec:
  destination:
    name: ''
    namespace: default
    server: 'https://kubernetes.default.svc'
  source:
    path: argorollout-blue-green
    repoURL: 'http://gitlab.cuiliangblog.cn/devops/argo-demo.git'
    targetRevision: main
  sources: []
  project: devops
  syncPolicy:
    automated:
      prune: false
      selfHeal: false
[root@tiaoban argocd]# kubectl apply -f blue-green.yaml 
application.argoproj.io/blue-green created
```

## 查看验证
查看argo dashboard，已经显示blue-green应用成功部署。

![](images/1768648878815_1761203010452-8b5402ee-1767-42aa-b4f3-aa6018560435.png)

CLI查看应用状态

```bash
[root@tiaoban argocd]# argocd login argocd.cuiliangblog.cn
[root@tiaoban argocd]# argocd app list --grpc-web          
NAME                   CLUSTER                         NAMESPACE  PROJECT  STATUS  HEALTH   SYNCPOLICY  CONDITIONS  REPO                                                PATH                    TARGET
argocd/blue-green      https://kubernetes.default.svc  default    devops   Synced  Healthy  Auto        <none>      http://gitlab.cuiliangblog.cn/devops/argo-demo.git  argorollout-blue-green  main
argocd/demo-helm       https://kubernetes.default.svc  test       devops   Synced  Healthy  Auto        <none>      http://gitlab.cuiliangblog.cn/devops/argo-demo.git  helm                    HEAD
argocd/demo-kustomize  https://kubernetes.default.svc  dev        devops   Synced  Healthy  Auto        <none>      http://gitlab.cuiliangblog.cn/devops/argo-demo.git  kustomize/overlays/dev  HEAD
argocd/demo-yaml       https://kubernetes.default.svc  default    devops   Synced  Healthy  Auto        <none>      http://gitlab.cuiliangblog.cn/devops/argo-demo.git  manifests               HEAD
[root@tiaoban argocd]# kubectl get application -n argocd
NAME             SYNC STATUS   HEALTH STATUS
blue-green       Synced        Healthy
demo-helm        Synced        Healthy
demo-kustomize   Synced        Healthy
demo-yaml        Synced        Healthy
```

kubectl查看状态

```bash
[root@tiaoban argocd]# kubectl get pod
NAME                               READY   STATUS    RESTARTS        AGE
bluegreen-rollout-95d95c65-gqwx5   1/1     Running   0               70s
bluegreen-rollout-95d95c65-pztls   1/1     Running   0               70s
[root@tiaoban argocd]# kubectl get svc
NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
bluegreen-active    ClusterIP   10.111.161.232   <none>        80/TCP    84s
bluegreen-preview   ClusterIP   10.100.217.118   <none>        80/TCP    84s
[root@tiaoban argocd]# kubectl get ingressroute
NAME         AGE
myapp-prod   96s
myapp-test   96s
```

添加hosts解析后访问ingress验证

![](images/1768648878896_1719203794919-2eca41cc-d502-4e9a-914d-9f57e8b42137.png)

![](images/1768648878957_1719205046099-ebc3ec86-5e97-4311-b7fb-b66b2e9d6e5c.png)

由于刚发布第一个版本，因此正式环境和测试环境都是v1版本的镜像。

# 更新版本
## 查看Rollouts状态
在更新应用版本前，先查看Rollouts状态，便于后续更新后对比效果。

```yaml
[root@tiaoban argocd]# kubectl argo rollouts list rollouts
NAME               STRATEGY   STATUS        STEP  SET-WEIGHT  READY  DESIRED  UP-TO-DATE  AVAILABLE
bluegreen-rollout  BlueGreen  Healthy       -     -           2/2    2        2           2        
[root@tiaoban argocd]# kubectl argo rollouts status bluegreen-rollout
Healthy
# 获取滚动更新详细信息
[root@tiaoban argocd]# kubectl argo rollouts get rollout bluegreen-rollout --watch
Name:            bluegreen-rollout
Name:            bluegreen-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v1 (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS     AGE  INFO
⟳ bluegreen-rollout                            Rollout     ✔ Healthy  16s  
└──# revision:1                                                            
   └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  ✔ Healthy  16s  stable,active
      ├──□ bluegreen-rollout-69dc9f5f56-b4cqq  Pod         ✔ Running  16s  ready:1/1
      └──□ bluegreen-rollout-69dc9f5f56-b5z9x  Pod         ✔ Running  16s  ready:1/1
```

此时可以看到，只有一个bluegreen-rollout-69dc9f5f56控制器在提供服务。

## 更新应用版本
修改rollout.yaml，将image镜像从v1升级为v2。

```bash
[root@tiaoban argo-demo]# cat argorollout-blue-green/rollout.yaml | grep image
        image: ikubernetes/myapp:v2
[root@tiaoban argo-demo]# git add . && git commit -m "update v2" && git push
```

## 再次查看Rollouts状态
待ArgoCD完成自动部署后，再次查看资源状态信息。此时可以发现ikubernetes/myapp:v1是生产版本，而ikubernetes/myapp:v2是预览测试版本。

```bash
[root@tiaoban argocd]# kubectl argo rollouts get rollout bluegreen-rollout
Name:            bluegreen-rollout
Name:            bluegreen-rollout
Namespace:       default
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v1 (stable, active)
                 ikubernetes/myapp:v2 (preview)
Replicas:
  Desired:       2
  Current:       3
  Updated:       1
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS     AGE    INFO
⟳ bluegreen-rollout                            Rollout     ॥ Paused   2m57s  
├──# revision:2                                                              
│  └──⧉ bluegreen-rollout-95d95c65             ReplicaSet  ✔ Healthy  48s    preview
│     └──□ bluegreen-rollout-95d95c65-wcbrs    Pod         ✔ Running  48s    ready:1/1
└──# revision:1                                                              
   └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  ✔ Healthy  2m57s  stable,active
      ├──□ bluegreen-rollout-69dc9f5f56-b4cqq  Pod         ✔ Running  2m57s  ready:1/1
      └──□ bluegreen-rollout-69dc9f5f56-b5z9x  Pod         ✔ Running  2m57s  ready:1/1
```

此时查看pod信息，新增了bluegreen-rollout-95d95c65的pod，运行v2版本的镜像。

```bash
[root@tiaoban ~]# kubectl get pod                    
NAME                                 READY   STATUS    RESTARTS         AGE
bluegreen-rollout-69dc9f5f56-b4cqq   1/1     Running   0                3m22s
bluegreen-rollout-69dc9f5f56-b5z9x   1/1     Running   0                3m22s
bluegreen-rollout-95d95c65-wcbrs     1/1     Running   0                73s
```

此时访问应用生产和测试域名，分别返回不同的版本信息。

![](images/1768648879016_1719206592491-b70a8e71-2cb6-494d-9808-78fa8863b4d6.png)

![](images/1768648879077_1719206600887-46be898c-135e-44ae-9725-e9cee8b8613e.png)

## 手动切换版本
发布新版本后，此时就需要测试人员访问测试域名验证系统功能是否正常，验证无误后，将服务切换至生产域名。

因为配置文件中 autoPromotionEnabled: false，需要在命令行手动执行版本切换。

```bash
[root@tiaoban argocd]# kubectl argo rollouts promote bluegreen-rollout
rollout 'bluegreen-rollout' promoted
```

切换完成后再次查看rollouts状态，发现v2已经变为生产环境

```bash
[root@tiaoban argocd]# kubectl argo rollouts get rollout bluegreen-rollout
Name:            bluegreen-rollout
Name:            bluegreen-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v1
                 ikubernetes/myapp:v2 (stable, active)
Replicas:
  Desired:       2
  Current:       4
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS     AGE    INFO
⟳ bluegreen-rollout                            Rollout     ✔ Healthy  4m54s  
├──# revision:2                                                              
│  └──⧉ bluegreen-rollout-95d95c65             ReplicaSet  ✔ Healthy  2m45s  stable,active
│     ├──□ bluegreen-rollout-95d95c65-wcbrs    Pod         ✔ Running  2m45s  ready:1/1
│     └──□ bluegreen-rollout-95d95c65-zj4hk    Pod         ✔ Running  19s    ready:1/1
└──# revision:1                                                              
   └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  ✔ Healthy  4m54s  delay:11s
      ├──□ bluegreen-rollout-69dc9f5f56-b4cqq  Pod         ✔ Running  4m54s  ready:1/1
      └──□ bluegreen-rollout-69dc9f5f56-b5z9x  Pod         ✔ Running  4m54s  ready:1/1
```

稍后再次查看rollouts状态，v1已经成功删除。

```bash
[root@tiaoban argocd]# kubectl argo rollouts get rollout bluegreen-rollout
Name:            bluegreen-rollout
Name:            bluegreen-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v2 (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                         KIND        STATUS        AGE    INFO
⟳ bluegreen-rollout                          Rollout     ✔ Healthy     5m37s  
├──# revision:2                                                               
│  └──⧉ bluegreen-rollout-95d95c65           ReplicaSet  ✔ Healthy     3m28s  stable,active
│     ├──□ bluegreen-rollout-95d95c65-wcbrs  Pod         ✔ Running     3m28s  ready:1/1
│     └──□ bluegreen-rollout-95d95c65-zj4hk  Pod         ✔ Running     62s    ready:1/1
└──# revision:1                                                               
   └──⧉ bluegreen-rollout-69dc9f5f56         ReplicaSet  • ScaledDown  5m37s 
```

## 查看验证
此时访问web页面，生产和测试环境均返回v2版本信息。

![](images/1768648879137_1719206743497-c4e6df63-ec0a-40f0-8c9b-4ba1b8ed5451.png)

![](images/1768648879243_1719206754590-e38678c6-250a-4563-884f-83ef30c4d20d.png)

此时查看dashboard页面，内容如下

![](images/1768648879304_1761204013908-fb63452e-7bfd-4833-958b-0850ed886207.png)

# 版本回退
如果将新版本推送至生产环境，此时发现系统存在问题，就需要进行版本回退，可通过以下方式执行回退。

## Rollouts dashboard
查看当前rollouts状态，生产环境使用v2版本。

```bash
[root@tiaoban ~]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v2 (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                         KIND        STATUS        AGE    INFO
⟳ bluegreen-rollout                          Rollout     ✔ Healthy     2m25s  
├──# revision:2                                                               
│  └──⧉ bluegreen-rollout-95d95c65           ReplicaSet  ✔ Healthy     88s    stable,active
│     ├──□ bluegreen-rollout-95d95c65-w4xrj  Pod         ✔ Running     88s    ready:1/1
│     └──□ bluegreen-rollout-95d95c65-52swj  Pod         ✔ Running     71s    ready:1/1
└──# revision:1                                                               
   └──⧉ bluegreen-rollout-69dc9f5f56         ReplicaSet  • ScaledDown  2m25s
```

执行版本回退

![](images/1768648879398_1719240687696-1a9219d5-81ef-4471-a94c-515137a1b9e8.png)

查看rollouts状态，v1为预览测试版，v2为生产版本。

```bash
[root@tiaoban ~]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v1 (preview)
                 ikubernetes/myapp:v2 (stable, active)
Replicas:
  Desired:       2
  Current:       3
  Updated:       1
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS     AGE    INFO
⟳ bluegreen-rollout                            Rollout     ॥ Paused   3m31s  
├──# revision:3                                                              
│  └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  ✔ Healthy  3m31s  preview
│     └──□ bluegreen-rollout-69dc9f5f56-6dsc6  Pod         ✔ Running  13s    ready:1/1
└──# revision:2                                                              
   └──⧉ bluegreen-rollout-95d95c65             ReplicaSet  ✔ Healthy  2m34s  stable,active
      ├──□ bluegreen-rollout-95d95c65-w4xrj    Pod         ✔ Running  2m34s  ready:1/1
      └──□ bluegreen-rollout-95d95c65-52swj    Pod         ✔ Running  2m17s  ready:1/1
```

手动切换版本

```bash
[root@tiaoban argocd]# kubectl argo rollouts promote bluegreen-rollout
rollout 'bluegreen-rollout' promoted
```

此时查看看rollouts状态，v1为生产版本，v2已删除。

```bash
[root@tiaoban ~]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v1 (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS        AGE    INFO
⟳ bluegreen-rollout                            Rollout     ✔ Healthy     5m20s  
├──# revision:3                                                                 
│  └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  ✔ Healthy     5m20s  stable,active
│     ├──□ bluegreen-rollout-69dc9f5f56-6dsc6  Pod         ✔ Running     2m2s   ready:1/1
│     └──□ bluegreen-rollout-69dc9f5f56-6v8hs  Pod         ✔ Running     34s    ready:1/1
└──# revision:2                                                                 
   └──⧉ bluegreen-rollout-95d95c65             ReplicaSet  • ScaledDown  4m23s 
```

版本回退至此完成。

## ArgoCD dashboard
![](images/1768648879469_1719207277591-1d3cd8e7-56db-411d-80b8-b28a68ff6513.png)

查看当前rollouts状态，生产环境使用v3版本。

```bash
[root@tiaoban ~]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v3 (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS        AGE   INFO
⟳ bluegreen-rollout                            Rollout     ✔ Healthy     8m1s  
├──# revision:4                                                                
│  └──⧉ bluegreen-rollout-68c7647dbb           ReplicaSet  ✔ Healthy     108s  stable,active
│     ├──□ bluegreen-rollout-68c7647dbb-2rkrc  Pod         ✔ Running     108s  ready:1/1
│     └──□ bluegreen-rollout-68c7647dbb-wlcmg  Pod         ✔ Running     93s   ready:1/1
├──# revision:3                                                                
│  └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  • ScaledDown  8m1s  
└──# revision:2                                                                
   └──⧉ bluegreen-rollout-95d95c65             ReplicaSet  • ScaledDown  7m4s
```

执行版本回退

![](images/1768648879562_1719241021975-3b315399-e6d9-4dd9-873b-39d4c637913f.png)

查看rollouts状态，v2为预览测试版，v3为生产版本。

```bash
[root@tiaoban ~]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v2 (preview)
                 ikubernetes/myapp:v3 (stable, active)
Replicas:
  Desired:       2
  Current:       3
  Updated:       1
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS        AGE    INFO
⟳ bluegreen-rollout                            Rollout     ॥ Paused      9m12s  
├──# revision:5                                                                 
│  └──⧉ bluegreen-rollout-95d95c65             ReplicaSet  ✔ Healthy     8m15s  preview
│     └──□ bluegreen-rollout-95d95c65-s5tfd    Pod         ✔ Running     19s    ready:1/1
├──# revision:4                                                                 
│  └──⧉ bluegreen-rollout-68c7647dbb           ReplicaSet  ✔ Healthy     2m59s  stable,active
│     ├──□ bluegreen-rollout-68c7647dbb-2rkrc  Pod         ✔ Running     2m59s  ready:1/1
│     └──□ bluegreen-rollout-68c7647dbb-wlcmg  Pod         ✔ Running     2m44s  ready:1/1
└──# revision:3                                                                 
   └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  • ScaledDown  9m12s 
```

手动切换版本

```bash
[root@tiaoban argocd]# kubectl argo rollouts promote bluegreen-rollout
rollout 'bluegreen-rollout' promoted
```

此时查看看rollouts状态，v2为生产版本，v3已删除。

```bash
[root@tiaoban ~]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v2 (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS         AGE    INFO
⟳ bluegreen-rollout                            Rollout     ✔ Healthy      10m    
├──# revision:5                                                                  
│  └──⧉ bluegreen-rollout-95d95c65             ReplicaSet  ✔ Healthy      9m31s  stable,active
│     ├──□ bluegreen-rollout-95d95c65-s5tfd    Pod         ✔ Running      95s    ready:1/1
│     └──□ bluegreen-rollout-95d95c65-dqbrf    Pod         ✔ Running      33s    ready:1/1
├──# revision:4                                                                  
│  └──⧉ bluegreen-rollout-68c7647dbb           ReplicaSet  • ScaledDown   4m15s  
│     └──□ bluegreen-rollout-68c7647dbb-wlcmg  Pod         ◌ Terminating  4m     ready:0/1
└──# revision:3                                                                  
   └──⧉ bluegreen-rollout-69dc9f5f56           ReplicaSet  • ScaledDown   10m 
```

版本回退至此完成。

# 中止发布
例如，在蓝绿部署中，将一部分流量切换到测试环境进行测试，但发现测试环境有重大问题。使用需要停止流量切换过程，保持生产环境继续接收所有流量。

## 更新应用版本
更新v3至测试环境，模拟发布新版本。

```bash
[root@tiaoban argo-demo]# cat argorollout-blue-green/rollout.yaml | grep image
        image: ikubernetes/myapp:v3
[root@tiaoban argo-demo]# git add . && git commit -m "update v3" && git push
```

查看rollouts状态，发现v3已经变为测试环境

```bash
[root@tiaoban argocd]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v2 (stable, active)
                 ikubernetes/myapp:v3 (preview)
Replicas:
  Desired:       2
  Current:       3
  Updated:       1
  Ready:         2
  Available:     2

NAME                                          KIND        STATUS        AGE    INFO
⟳ bluegreen-rollout                           Rollout     ॥ Paused      8m30s  
├──# revision:3                                                                
│  └──⧉ bluegreen-rollout-cbb459d74           ReplicaSet  ✔ Healthy     87s    preview
│     └──□ bluegreen-rollout-cbb459d74-857w8  Pod         ✔ Running     87s    ready:1/1
├──# revision:2                                                                
│  └──⧉ bluegreen-rollout-95d95c65            ReplicaSet  ✔ Healthy     6m53s  stable,active
│     ├──□ bluegreen-rollout-95d95c65-rs9n7   Pod         ✔ Running     6m53s  ready:1/1
│     └──□ bluegreen-rollout-95d95c65-4nxwc   Pod         ✔ Running     5m20s  ready:1/1
└──# revision:1                                                                
   └──⧉ bluegreen-rollout-69dc9f5f56          ReplicaSet  • ScaledDown  8m30s
```

## 执行中止操作
此时发现v3版本存在重大bug，需要停止发布流程。

```bash
[root@tiaoban ~]# kubectl argo rollouts abort bluegreen-rollout
rollout 'bluegreen-rollout' aborted
```

此时查看rollouts状态，发现v3测试环境已删除。

```bash
[root@tiaoban argocd]# kubectl argo rollouts get rollout bluegreen-rollout 
Name:            bluegreen-rollout
Namespace:       default
Status:          ✖ Degraded
Message:         RolloutAborted: Rollout aborted update to revision 3
Strategy:        BlueGreen
Images:          ikubernetes/myapp:v2 (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       0
  Ready:         2
  Available:     2

NAME                                         KIND        STATUS        AGE    INFO
⟳ bluegreen-rollout                          Rollout     ✖ Degraded    9m59s  
├──# revision:3                                                               
│  └──⧉ bluegreen-rollout-cbb459d74          ReplicaSet  • ScaledDown  2m56s  preview,delay:passed
├──# revision:2                                                               
│  └──⧉ bluegreen-rollout-95d95c65           ReplicaSet  ✔ Healthy     8m22s  stable,active
│     ├──□ bluegreen-rollout-95d95c65-rs9n7  Pod         ✔ Running     8m22s  ready:1/1
│     └──□ bluegreen-rollout-95d95c65-4nxwc  Pod         ✔ Running     6m49s  ready:1/1
└──# revision:1                                                               
   └──⧉ bluegreen-rollout-69dc9f5f56         ReplicaSet  • ScaledDown  9m59s 
```

此时访问生产环境，仍然可以正常访问v2版本服务

![](images/1768648879650_1719237292145-96746e06-0750-4726-b651-09b69f8b0dd3.png)

访问测试环境，已经无法提供服务。

![](images/1768648879709_1719237313995-bb36d0e4-96aa-4b8f-adfb-7d82bf133eb3.png)


