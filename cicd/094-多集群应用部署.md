# 多集群应用部署

> 来源: CI/CD
> 创建时间: 2024-06-23T12:31:31+08:00
> 更新时间: 2026-01-17T19:21:20.817563+08:00
> 阅读量: 557 | 点赞: 0

---

# 简介
## 方案介绍
ArgoCD基于声明式配置和同步机制，适用于多环境部署、跨区域/跨云部署、高可用性和灾难恢复、统一管理和监控、合规性和审计，以及团队协作等场景。通过这些功能和特点，ArgoCD 大大简化了多集群应用管理的复杂性，提高了部署和运维的效率。

## 适用场景
1. **多环境部署**：适用于在不同环境（例如开发、测试、生产）中部署相同的应用程序。每个环境可以对应一个不同的 Kubernetes 集群，ArgoCD 可以确保每个环境的配置一致性。
2. **跨区域/跨云部署**：当需要在多个地理区域或多个云提供商（如 AWS、GCP、Azure）中部署应用程序时，ArgoCD 多集群支持可以简化跨区域或跨云的部署管理。
3. **高可用性和灾难恢复**：通过在多个集群中部署相同的应用程序，可以实现高可用性和灾难恢复。如果一个集群发生故障，其他集群仍然可以继续提供服务。
4. **统一管理和监控**：对于拥有多个 Kubernetes 集群的组织，ArgoCD 提供了统一的管理和监控界面，使得运维团队可以在一个界面中查看和管理所有集群中的应用部署状态。
5. **合规性和审计**：通过 Git 仓库管理所有的配置文件，所有的变更都有记录和审计历史。确保配置变更的可追溯性和合规性。
6. **团队协作**：不同的团队可以在同一个或多个 Git 仓库中协作管理应用配置，ArgoCD 确保不同团队的配置变更能够一致地应用到目标集群中。

# 创建多集群应用
## 添加集群
假设现在有两套集群，已经在k8s-ha集群部署了gitlab和Argocd，现在需要添加k8s-test集群。

在添加集群前，先配置config上下文，具体内容可参考文档：[https://www.cuiliangblog.cn/detail/section/175557663](https://www.cuiliangblog.cn/detail/section/175557663)

```bash
[root@tiaoban .kube]# kubectl config get-contexts
CURRENT   NAME                  CLUSTER    AUTHINFO     NAMESPACE
*         ha-admin@k8s-ha       k8s-ha     ha-admin     
          test-admin@k8s-test   k8s-test   test-admin 
[root@tiaoban .kube]# kubectl get node
NAME      STATUS   ROLES           AGE    VERSION
master1   Ready    control-plane   285d   v1.27.6
master2   Ready    control-plane   285d   v1.27.6
master3   Ready    control-plane   285d   v1.27.6
work1     Ready    <none>          285d   v1.27.6
work2     Ready    <none>          285d   v1.27.6
work3     Ready    <none>          285d   v1.27.6
[root@tiaoban .kube]# kubectl config use-context test-admin@k8s-test
Switched to context "test-admin@k8s-test".
[root@tiaoban .kube]# kubectl get node
NAME         STATUS   ROLES                  AGE   VERSION
k8s-master   Ready    control-plane,master   21h   v1.23.17
k8s-work1    Ready    <none>                 20h   v1.23.17
k8s-work2    Ready    <none>                 20h   v1.23.17
```

ArgoCD添加集群

```bash
[root@tiaoban ~]# argocd login argocd.local.com
WARNING: server certificate had error: tls: failed to verify certificate: x509: certificate is valid for de4d64dda4cc17aa063ca24baa2abc22.6d1744aa3a6f00c3129e20bc6d196dd0.traefik.default, not argocd.local.com. Proceed insecurely (y/n)? y
WARN[0002] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web. 
Username: admin
Password: 
'admin:login' logged in successfully
Context 'argocd.local.com' updated
[root@tiaoban ~]# argocd cluster add test-admin@k8s-test --kubeconfig=/root/.kube/config
WARNING: This will create a service account `argocd-manager` on the cluster referenced by context `test-admin@k8s-test` with full cluster level privileges. Do you want to continue [y/N]? y
INFO[0003] ServiceAccount "argocd-manager" created in namespace "kube-system" 
INFO[0003] ClusterRole "argocd-manager-role" created    
INFO[0003] ClusterRoleBinding "argocd-manager-role-binding" created 
WARN[0004] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web. 
Cluster 'https://192.168.10.10:6443' added
```

查看集群状态信息如下

![](images/1768648880843_1719580141500-a072a55a-f4fc-4965-a504-9e2d376d3f3e.png)

## 创建Project
创建名为test的项目，授权k8s-test集群进行操作。

![](images/1768648880908_1719580342301-908a8561-7a96-4450-8fec-f81fef727a8e.png)

## 创建应用
继续使用app of apps项目yaml文件，修改applications.yaml，模拟将其中一个子应用发布至test集群。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application # 子应用1，发布至default项目
metadata:
  name: app1
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'http://gitlab.local.com/devops/argo-demo.git'
    path: 'app-of-apps/app1'
    targetRevision: HEAD
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
---
apiVersion: argoproj.io/v1alpha1
kind: Application # 子应用2，发布至test项目
metadata:
  name: app2 
  namespace: argocd
spec:
  project: test # 指定test项目
  source:
    repoURL: 'http://gitlab.local.com/devops/argo-demo.git'
    path: 'app-of-apps/app2'
    targetRevision: HEAD
  destination:
    server: 'https://192.168.10.10:6443' # 修改为test集群地址
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

## 发布验证
修改完applications.yaml后推送至仓库，argoCD会自动进行发布，查看发布信息如下：

![](images/1768648880982_1719582269817-c295b5f8-27c6-4d91-a267-f93406ab2463.png)

此时访问test集群查看资源，已经成功创建myapp2资源。

```yaml
[root@tiaoban ~]# kubectl config use-context test-admin@k8s-test
Switched to context "test-admin@k8s-test".
[root@tiaoban ~]# kubectl get pod
NAME                      READY   STATUS    RESTARTS   AGE
myapp2-7f8b7dfcc8-7lhd7   1/1     Running   0          2m4s
```


